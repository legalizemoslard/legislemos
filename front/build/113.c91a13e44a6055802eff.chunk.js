(window.webpackJsonp=window.webpackJsonp||[]).push([[113,167],{"/pS6":function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;t.default={titleProfanityError:{name:"Profane proposal title blocked"},descriptionProfanityError:{name:"Profane proposal description blocked"}}},"3SKu":function(e,t,a){"use strict";var n=a("TqRt");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(a("fHP9"));t.default=function(e){var t=e.children,a=e.action;return t((0,i.default)(a))}},JtI7:function(e,t,a){"use strict";var n=a("TqRt");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(a("pVnL"));a("ma9I");var r=n(a("q1tI")),o=a("qhky"),s=a("ifvJ"),l=n(a("gSjc")),u=a("Rw3A"),d=n(a("YLV/")),c=n(a("phbu")),f=n(a("wbnS")),p=n(a("+YyL")),v=r.default.memo((function(e){var t=e.intl,a=e.authUser,n=e.tenantLocales,i=t.formatMessage,s=window.location,u=i(l.default.metaTitle),d=i(l.default.metaDescription);return r.default.createElement(o.Helmet,null,r.default.createElement("title",null,"\n          ".concat(a&&a.attributes.unread_notifications?"(".concat(a.attributes.unread_notifications,") "):"","\n          ").concat(u)),(0,f.default)(n),(0,p.default)(),r.default.createElement("meta",{name:"title",content:u}),r.default.createElement("meta",{name:"description",content:d}),r.default.createElement("meta",{property:"og:title",content:u}),r.default.createElement("meta",{property:"og:description",content:d}),r.default.createElement("meta",{property:"og:url",content:s.href}))})),h=(0,u.injectIntl)(v),m=(0,s.adopt)({tenantLocales:r.default.createElement(c.default,null),authUser:r.default.createElement(d.default,null)});t.default=function(e){return r.default.createElement(m,e,(function(t){return r.default.createElement(h,(0,i.default)({},e,t))}))}},P7vb:function(e,t,a){"use strict";a("SuFq"),a("pNMO"),a("5DmW"),a("FZtP"),a("27RR");var n=a("TqRt");Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.InitiativesNewFormWrapper=void 0;var i=n(a("pVnL")),r=n(a("QILm")),o=n(a("o0o1"));a("TeQF"),a("tkto"),a("fbCW"),a("sMBO"),a("ma9I"),a("2B1R");var s,l=n(a("RIqP")),u=n(a("yXPU")),d=n(a("lwsE")),c=n(a("W8MJ")),f=n(a("PJYZ")),p=n(a("7W2i")),v=n(a("a1gu")),h=n(a("Nsbk")),m=n(a("lSNA")),g=n(a("VkAN")),b=n(a("q1tI")),y=a("ifvJ"),I=n(a("St88")),P=a("fM+I"),E=a("KLnl"),_=a("96Cm"),S=n(a("JUYq")),k=n(a("vOnD")),w=a("mGTj"),O=a("T89o"),x=a("gkAX"),N=a("OKda"),C=a("bQOE"),j=n(a("/pS6")),R=a("KuRP"),T=n(a("YLV/")),F=n(a("yYlr")),B=["initiativeId","hasBannerChanged","hasImageChanged","titleProfanityError","descriptionProfanityError"];function M(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function V(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?M(Object(a),!0).forEach((function(t){(0,m.default)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):M(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function U(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var a,n=(0,h.default)(e);if(t){var i=(0,h.default)(this).constructor;a=Reflect.construct(n,arguments,i)}else a=n.apply(this,arguments);return(0,v.default)(this,a)}}var q=(0,k.default)(I.default).withConfig({displayName:"InitiativesNewFormWrapper__StyledInitiativeForm",componentId:"sc-1xsskma-0"})(["width:100%;min-width:530px;height:900px;",""],_.media.smallerThanMaxTablet(s||(s=(0,g.default)(["\n    min-width: 230px;\n  "])))),J=function(e){(0,p.default)(s,e);var t,a,n=U(s);function s(e){var t;return(0,d.default)(this,s),t=n.call(this,e),(0,m.default)((0,f.default)(t),"initialValues",void 0),(0,m.default)((0,f.default)(t),"changedValues",(function(){var e=Object.keys(t.initialValues).filter((function(e){return!(0,O.isEqual)(t.initialValues[e],t.state[e])}));return(0,O.pick)(t.state,e)})),(0,m.default)((0,f.default)(t),"handleSave",(0,u.default)(o.default.mark((function e(){var a,n,i,r,s,l,u,d,c,f,p;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.changedValues(),n=t.state,i=n.initiativeId,r=n.hasBannerChanged,s=n.hasImageChanged,l=n.image,u=n.banner,d=n.saving,!(0,O.isEmpty)(a)||r||s){e.next=4;break}return e.abrupt("return");case 4:if(!d){e.next=6;break}return e.abrupt("return");case 6:return t.setState({saving:!0}),e.prev=7,e.next=10,t.getValuesToSend(a,r,u);case 10:if(c=e.sent,(0,O.isEmpty)(c)){e.next=24;break}if(!i){e.next=18;break}return e.next=15,(0,P.updateInitiative)(i,c);case 15:f=e.sent,e.next=22;break;case 18:return e.next=20,(0,P.addInitiative)(V(V({},c),{},{publication_status:"draft"}));case 20:f=e.sent,t.setState({initiativeId:f.data.id});case 22:t.initialValues=t.getFormValues(f.data),t.setState({hasBannerChanged:!1});case 24:if(!s||!i){e.next=34;break}if(!l||!l.base64){e.next=32;break}return e.next=28,(0,x.addInitiativeImage)(i,l.base64);case 28:p=e.sent,t.setState({imageId:p.data.id}),e.next=33;break;case 32:!l&&t.state.imageId?((0,x.deleteInitiativeImage)(i,t.state.imageId),t.setState({imageId:null})):(0,C.reportError)("There was an error with an initiative image");case 33:t.setState({hasImageChanged:!1});case 34:t.setState({saving:!1}),e.next=40;break;case 37:e.prev=37,e.t0=e.catch(7),t.setState({saving:!1});case 40:case"end":return e.stop()}}),e,null,[[7,37]])})))),(0,m.default)((0,f.default)(t),"debouncedSave",(0,O.debounce)(t.handleSave,500)),(0,m.default)((0,f.default)(t),"handlePublish",(0,u.default)(o.default.mark((function e(){var a,n,i,r,s,l,u,d,c,f,p,v,h,m,g,b,y,I,_,k,w;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.changedValues(),n=t.state,i=n.initiativeId,r=n.hasBannerChanged,s=n.hasImageChanged,l=n.image,u=n.banner,d=n.publishing,c=t.props,f=c.locale,p=c.appConfiguration,v=c.authUser,!d){e.next=5;break}return e.abrupt("return");case 5:return t.setState({publishing:!0}),e.prev=6,e.next=9,t.getValuesToSend(a,r,u);case 9:if(h=e.sent,!i){e.next=16;break}return e.next=13,(0,P.updateInitiative)(i,V(V({},h),{},{publication_status:"published"}));case 13:m=e.sent,e.next=20;break;case 16:return e.next=18,(0,P.addInitiative)(V(V({},h),{},{publication_status:"published"}));case 18:m=e.sent,t.setState({initiativeId:m.data.id});case 20:if(t.initialValues=t.getFormValues(m.data),t.setState({hasBannerChanged:!1}),!s||!i){e.next=32;break}if(!l||!l.base64){e.next=30;break}return e.next=26,(0,x.addInitiativeImage)(i,l.base64);case 26:g=e.sent,t.setState({imageId:g.data.id}),e.next=31;break;case 30:!l&&t.state.imageId?(0,x.deleteInitiativeImage)(i,t.state.imageId).then((function(){t.setState({imageId:null})})):l&&(0,C.reportError)("Unexpected state of initiative image");case 31:t.setState({hasImageChanged:!1});case 32:t.setState({publishing:!1}),S.default.push({pathname:"/initiatives/".concat(m.data.attributes.slug),search:"?new_initiative_id=".concat(m.data.id)}),e.next=43;break;case 36:e.prev=36,e.t0=e.catch(6),t.setState({publishing:!1}),b=(0,O.get)(e.t0,"json.errors"),(y=b.base.find((function(e){return"includes_banned_words"===e.error})))&&(I=y.blocked_words.some((function(e){return"title_multiloc"===e.attribute})),_=y.blocked_words.some((function(e){return"body_multiloc"===e.attribute})),I&&((0,R.trackEventByName)(j.default.titleProfanityError.name,{locale:f,profaneMessage:null===(k=a.title_multiloc)||void 0===k?void 0:k[f],proposalId:i,location:"InitiativesNewFormWrapper (citizen side)",userId:(0,E.isNilOrError)(v)?null:v.id,host:(0,E.isNilOrError)(p)?null:p.attributes.host}),t.setState({titleProfanityError:I})),_&&((0,R.trackEventByName)(j.default.descriptionProfanityError.name,{locale:f,profaneMessage:null===(w=a.body_multiloc)||void 0===w?void 0:w[f],proposalId:i,location:"InitiativesNewFormWrapper (citizen side)",userId:(0,E.isNilOrError)(v)?null:v.id,host:(0,E.isNilOrError)(p)?null:p.attributes.host}),t.setState({descriptionProfanityError:_}))),t.setState((function(e){return{apiErrors:V(V({},e.apiErrors),b),publishError:!0}}));case 43:case"end":return e.stop()}}),e,null,[[6,36]])})))),(0,m.default)((0,f.default)(t),"onChangeTitle",(function(e){t.setState({title_multiloc:e,titleProfanityError:!1})})),(0,m.default)((0,f.default)(t),"onChangeBody",(function(e){t.setState({body_multiloc:e,descriptionProfanityError:!1})})),(0,m.default)((0,f.default)(t),"onChangeTopics",(function(e){t.setState({topic_ids:e})})),(0,m.default)((0,f.default)(t),"onChangePosition",(function(e){t.setState({position:e,location_point_geojson:void 0})})),(0,m.default)((0,f.default)(t),"onChangeBanner",(function(e){t.setState({banner:e,hasBannerChanged:!0})})),(0,m.default)((0,f.default)(t),"onChangeImage",(function(e){t.setState({image:e,hasImageChanged:!0})})),(0,m.default)((0,f.default)(t),"onAddFile",(function(e){var a=t.state.initiativeId;a&&(t.setState({saving:!0}),(0,N.addInitiativeFile)(a,e.base64,e.name).then((function(a){e.id=a.data.id,t.setState((function(t){var a=t.files;return{files:[].concat((0,l.default)(a),[e]),saving:!1}}))})).catch((function(e){var a=(0,O.get)(e,"json.errors");t.setState((function(e){return{apiErrors:V(V({},e.apiErrors),a),saving:!1}})),setTimeout((function(){t.setState((function(e){return{apiErrors:V(V({},e.apiErrors),{},{file:void 0})}}))}),5e3)})))})),(0,m.default)((0,f.default)(t),"onRemoveFile",(function(e){var a=t.state.initiativeId;a&&e.id&&(t.setState({saving:!0}),(0,N.deleteInitiativeFile)(a,e.id).then((function(){return t.setState((function(t){return{files:t.files.filter((function(t){return t.base64!==e.base64})),saving:!1}}))})))})),t.initialValues={title_multiloc:void 0,body_multiloc:void 0,topic_ids:[],position:void 0},t.state=V(V({},t.initialValues),{},{initiativeId:null,saving:!1,publishing:!1,hasBannerChanged:!1,hasImageChanged:!1,imageId:null,banner:void 0,image:void 0,files:[],publishError:!1,apiErrors:null,position:e.location_description,location_point_geojson:e.location_point_geojson,titleProfanityError:!1,descriptionProfanityError:!1}),t}return(0,c.default)(s,[{key:"componentDidMount",value:function(){var e=this;(0,P.addInitiative)({publication_status:"draft"}).then((function(t){e.setState({initiativeId:t.data.id})}))}},{key:"parsePosition",value:(a=(0,u.default)(o.default.mark((function e(t){var a,n;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t,e.next=null===e.t0||""===e.t0?3:void 0===e.t0?6:9;break;case 3:return a=null,n=null,e.abrupt("break",14);case 6:return a=void 0,n=void 0,e.abrupt("break",14);case 9:return e.next=11,(0,w.geocode)(t);case 11:return a=e.sent,n=t,e.abrupt("break",14);case 14:return e.abrupt("return",{location_point_geojson:a,location_description:n});case 15:case"end":return e.stop()}}),e)}))),function(e){return a.apply(this,arguments)})},{key:"getValuesToSend",value:(t=(0,u.default)(o.default.mark((function e(t,a,n){var i,r,s,l,u,d,c;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.title_multiloc,r=t.body_multiloc,s=t.topic_ids,l=t.position,!(u=this.state.location_point_geojson)){e.next=6;break}d={location_point_geojson:u,location_description:l},e.next=9;break;case 6:return e.next=8,this.parsePosition(l);case 8:d=e.sent;case 9:return c=(0,O.omitBy)(V({title_multiloc:i,body_multiloc:r,topic_ids:s},d),(function(e){return void 0===e})),a&&(c.header_bg=n?n.base64:null),e.abrupt("return",c);case 12:case"end":return e.stop()}}),e,this)}))),function(e,a,n){return t.apply(this,arguments)})},{key:"getFormValues",value:function(e){return(0,E.isNilOrError)(e)?this.initialValues:{title_multiloc:(0,O.get)(e,"attributes.title_multiloc",void 0)||void 0,body_multiloc:(0,O.get)(e,"attributes.body_multiloc",void 0)||void 0,topic_ids:(0,O.get)(e,"relationships.topics.data",[]).map((function(e){return e.id})),position:(0,O.get)(e,"attributes.location_description",void 0)||void 0}}},{key:"render",value:function(){var e=this.state,t=(e.initiativeId,e.hasBannerChanged,e.hasImageChanged,e.titleProfanityError),a=e.descriptionProfanityError,n=(0,r.default)(e,B),o=this.props,s=o.locale,l=o.topics;return b.default.createElement(q,(0,i.default)({onPublish:this.handlePublish,onSave:this.debouncedSave,locale:s},n,{onChangeTitle:this.onChangeTitle,onChangeBody:this.onChangeBody,onChangeTopics:this.onChangeTopics,onChangePosition:this.onChangePosition,onChangeBanner:this.onChangeBanner,onChangeImage:this.onChangeImage,onAddFile:this.onAddFile,onRemoveFile:this.onRemoveFile,topics:l,titleProfanityError:t,descriptionProfanityError:a}))}}]),s}(b.default.PureComponent);t.InitiativesNewFormWrapper=J;var A=(0,y.adopt)({appConfiguration:b.default.createElement(F.default,null),authUser:b.default.createElement(T.default,null)});t.default=function(e){return b.default.createElement(A,e,(function(t){return b.default.createElement(J,(0,i.default)({},e,t))}))}},fHP9:function(e,t,a){"use strict";var n=a("TqRt");Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=(0,r.useState)(void 0),a=(0,i.default)(t,2),n=a[0],c=a[1];return(0,r.useEffect)((function(){var t=(0,d.combineLatest)((0,o.getInitiativeActionDescriptors)().observable,(0,l.currentAppConfigurationStream)().observable,(0,u.authUserStream)().observable).subscribe((function(t){var a=(0,i.default)(t,3),n=a[0],r=a[1],o=a[2];if(!(0,s.isNilOrError)(r)&&!(0,s.isNilOrError)(n)){var l=n[e];if(l.enabled)c({show:!0,enabled:!0,disabledReason:null,action:null});else switch(l.disabled_reason){case"not_verified":(0,s.isNilOrError)(o)?c({show:!0,enabled:"maybe",disabledReason:null,action:"sign_in_up_and_verify"}):c({show:!0,enabled:"maybe",disabledReason:null,action:"verify"});break;case"not_signed_in":c({show:!0,enabled:"maybe",disabledReason:null,action:"sign_in_up"});break;default:c({show:!0,enabled:!1,disabledReason:"notPermitted",action:null})}}}));return function(){return t.unsubscribe()}}),[]),n};var i=n(a("J4zp")),r=a("q1tI"),o=a("fM+I"),s=a("KLnl"),l=a("H9u3"),u=a("x303"),d=a("DtyJ")},gSjc:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=(0,a("JRPe").defineMessages)({metaTitle:{id:"app.containers.InitiativesNewPage.metaTitle",defaultMessage:"Start an Initiative • {orgName}"},metaDescription:{id:"app.containers.InitiativesNewPage.metaDescription",defaultMessage:"Start your own initiative and make your voice heard by {orgName}"},locationNotFound:{id:"app.containers.InitiativesNewPage.locationNotFound",defaultMessage:"We couldn't find an approximate address for the location you selected. You can confirm as is to save this location or type in an address to change it."},unkownAddress:{id:"app.containers.InitiativesNewPage.unkownAddress",defaultMessage:"Unknown address"}});t.default=n},qN4A:function(e,t,a){"use strict";a("SuFq");var n=a("TqRt");Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.InitiativesNewPage=void 0,a("rB9j"),a("UxlC"),a("hByQ"),a("TeQF");var i=n(a("pVnL")),r=n(a("lwsE")),o=n(a("W8MJ")),s=n(a("PJYZ")),l=n(a("7W2i")),u=n(a("a1gu")),d=n(a("Nsbk")),c=n(a("lSNA")),f=n(a("q1tI")),p=a("T89o"),v=n(a("JUYq")),h=a("ifvJ"),m=a("dtw8"),g=a("mGTj"),b=a("Qyje"),y=n(a("YLV/")),I=n(a("yiTP")),P=a("gSG5"),E=n(a("lPdK")),_=a("KLnl"),S=a("18VM"),k=n(a("JtI7")),w=n(a("P7vb")),O=n(a("AJ4R")),x=n(a("3SKu"));function N(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var a,n=(0,d.default)(e);if(t){var i=(0,d.default)(this).constructor;a=Reflect.construct(n,arguments,i)}else a=n.apply(this,arguments);return(0,u.default)(this,a)}}var C=function(e){(0,l.default)(a,e);var t=N(a);function a(e){var n;return(0,r.default)(this,a),n=t.call(this,e),(0,c.default)((0,s.default)(n),"redirectIfNotPermittedOnPage",(function(){null===n.props.authUser&&v.default.replace("/sign-up")})),n.state={locationInfo:void 0},n}return(0,o.default)(a,[{key:"componentDidMount",value:function(){var e=this,t=this.props.location,a=(0,b.parse)(t.search,{ignoreQueryPrefix:!0,decoder:function(e,t,a,n){return"value"===n?parseFloat(e):e}}),n=a.lat,i=a.lng;this.redirectIfNotPermittedOnPage(),(0,p.isNumber)(n)&&(0,p.isNumber)(i)?(0,g.reverseGeocode)(n,i).then((function(t){e.setState({locationInfo:{location_description:t,location_point_geojson:{type:"Point",coordinates:[i,n]}}})})):this.setState({locationInfo:null})}},{key:"componentDidUpdate",value:function(e){e.authUser!==this.props.authUser&&this.redirectIfNotPermittedOnPage(),e.postingPermission===this.props.postingPermission||(0,_.isNilOrError)(this.props.postingPermission)||this.redirectIfPostingNotEnabled()}},{key:"redirectIfPostingNotEnabled",value:function(){var e;!0===(null===(e=this.props.postingPermission)||void 0===e?void 0:e.enabled)||(0,_.isNilOrError)(this.props.authUser)||v.default.replace("/initiatives")}},{key:"render",value:function(){var e=this.props,t=e.authUser,a=e.locale,n=e.topics,r=this.state.locationInfo;if((0,_.isNilOrError)(t)||(0,_.isNilOrError)(a)||(0,_.isNilOrError)(n)||void 0===r)return null;var o=n.filter((function(e){return!(0,_.isNilOrError)(e)}));return f.default.createElement(f.default.Fragment,null,f.default.createElement(k.default,null),f.default.createElement(O.default,{isAdmin:(0,S.isAdmin)({data:t})},f.default.createElement(w.default,(0,i.default)({locale:a,topics:o},r))))}}]),a}(f.default.PureComponent);t.InitiativesNewPage=C;var j=(0,h.adopt)({authUser:f.default.createElement(y.default,null),locale:f.default.createElement(I.default,null),topics:f.default.createElement(E.default,{exclude_code:"custom"}),previousPathName:function(e){var t=e.render;return f.default.createElement(P.PreviousPathnameContext.Consumer,null,t)},postingPermission:f.default.createElement(x.default,{action:"posting_initiative"})}),R=(0,m.withRouter)((function(e){return f.default.createElement(j,null,(function(t){return f.default.createElement(C,(0,i.default)({},t,e))}))}));t.default=R}}]);
//# sourceMappingURL=113.c91a13e44a6055802eff.chunk.js.map