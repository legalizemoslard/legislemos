(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{FSVo:function(t,e,n){"use strict";n("SuFq");var i=n("TqRt");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,n("FZtP");var r=i(n("lwsE")),a=i(n("W8MJ")),o=i(n("PJYZ")),u=i(n("7W2i")),s=i(n("a1gu")),l=i(n("Nsbk")),c=i(n("lSNA")),f=i(n("q1tI")),d=n("T89o"),p=n("KLnl"),v=n("DtyJ"),h=n("ahDk"),b=i(n("aTp4")),m=n("fM+I");function g(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=(0,l.default)(t);if(e){var r=(0,l.default)(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(0,s.default)(this,n)}}var y=function(t){(0,u.default)(n,t);var e=g(n);function n(t){var i;return(0,r.default)(this,n),i=e.call(this,t),(0,c.default)((0,o.default)(i),"inputProps$",void 0),(0,c.default)((0,o.default)(i),"subscriptions",void 0),i.state={initiative:void 0},i}return(0,a.default)(n,[{key:"componentDidMount",value:function(){var t=this,e=this.props,n=e.id,i=e.slug,r=e.resetOnChange;this.inputProps$=new v.BehaviorSubject({id:n,slug:i}),this.subscriptions=[this.inputProps$.pipe((0,h.distinctUntilChanged)((function(t,e){return(0,b.default)(t,e)})),(0,h.tap)((function(){return r&&t.setState({initiative:void 0})})),(0,h.switchMap)((function(t){var e=t.id,n=t.slug;return(0,d.isString)(e)?(0,m.initiativeByIdStream)(e).observable:(0,d.isString)(n)?(0,m.initiativeBySlugStream)(n).observable:(0,v.of)(null)}))).subscribe((function(e){t.setState({initiative:(0,p.isNilOrError)(e)?e:e.data})}))]}},{key:"componentDidUpdate",value:function(){var t=this.props,e=t.id,n=t.slug;this.inputProps$.next({id:e,slug:n})}},{key:"componentWillUnmount",value:function(){this.subscriptions.forEach((function(t){return t.unsubscribe()}))}},{key:"render",value:function(){return(0,this.props.children)(this.state.initiative)}}]),n}(f.default.Component);e.default=y,(0,c.default)(y,"defaultProps",{resetOnChange:!0})},Y9MJ:function(t,e,n){"use strict";n("SuFq");var i=n("TqRt");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,n("2B1R"),n("sMBO"),n("TeQF"),n("FZtP");var r=i(n("lwsE")),a=i(n("W8MJ")),o=i(n("PJYZ")),u=i(n("7W2i")),s=i(n("a1gu")),l=i(n("Nsbk")),c=i(n("lSNA")),f=i(n("q1tI")),d=n("T89o"),p=n("KLnl"),v=n("DtyJ"),h=n("ahDk"),b=i(n("aTp4")),m=n("Nv6i"),g=n("jtPO"),y=n("vDWu"),P=n("pQfs"),S=n("c95D"),I=n("OKda"),E=n("1YJs");function k(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=(0,l.default)(t);if(e){var r=(0,l.default)(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(0,s.default)(this,n)}}var O=function(t){(0,u.default)(n,t);var e=k(n);function n(t){var i;return(0,r.default)(this,n),i=e.call(this,t),(0,c.default)((0,o.default)(i),"inputProps$",void 0),(0,c.default)((0,o.default)(i),"subscriptions",void 0),i.state={files:void 0},i}return(0,a.default)(n,[{key:"componentDidMount",value:function(){var t=this,e=this.props,n=e.resourceId,i=e.resourceType,r=e.resetOnChange;this.inputProps$=new v.BehaviorSubject({resourceId:n,resourceType:i}),this.subscriptions=[this.inputProps$.pipe((0,h.distinctUntilChanged)((function(t,e){return(0,b.default)(t,e)})),(0,h.tap)((function(){return r&&t.setState({files:void 0})})),(0,h.filter)((function(t){var e=t.resourceId;return(0,d.isString)(e)})),(0,h.switchMap)((function(t){var e,n=t.resourceId,i=t.resourceType;return"project"===i&&(e=m.projectFilesStream),"phase"===i&&(e=g.phaseFilesStream),"event"===i&&(e=P.eventFilesStream),"page"===i&&(e=y.pageFilesStream),"idea"===i&&(e=S.ideaFilesStream),"initiative"===i&&(e=I.initiativeFilesStream),e(n).observable})),(0,h.switchMap)((function(t){return t&&t.data&&t.data.length>0?(0,v.combineLatest)(t.data.map((function(t){return(0,E.convertUrlToUploadFileObservable)(t.attributes.file.url,t.id,t.attributes.name)}))):(0,v.of)(null)}))).subscribe((function(e){t.setState({files:e?e.filter((function(t){return!(0,p.isNilOrError)(t)})):null})}))]}},{key:"componentDidUpdate",value:function(){var t=this.props,e=t.resourceId,n=t.resourceType,i=t.resetOnChange;this.inputProps$.next({resourceId:e,resourceType:n,resetOnChange:i})}},{key:"componentWillUnmount",value:function(){this.subscriptions.forEach((function(t){return t.unsubscribe()}))}},{key:"render",value:function(){return(0,this.props.children)(this.state.files)}}]),n}(f.default.Component);e.default=O,(0,c.default)(O,"defaultProps",{resetOnChange:!0})},awBM:function(t,e,n){"use strict";n("SuFq"),n("pNMO"),n("5DmW"),n("FZtP"),n("27RR");var i=n("TqRt");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var r=i(n("pVnL")),a=i(n("QILm")),o=i(n("o0o1"));n("TeQF"),n("tkto"),n("2B1R"),n("sMBO"),n("fbCW"),n("ma9I");var u=i(n("RIqP")),s=i(n("yXPU")),l=i(n("lwsE")),c=i(n("W8MJ")),f=i(n("PJYZ")),d=i(n("7W2i")),p=i(n("a1gu")),v=i(n("Nsbk")),h=i(n("lSNA")),b=i(n("q1tI")),m=n("ifvJ"),g=i(n("St88")),y=n("fM+I"),P=n("gkAX"),S=n("OKda"),I=n("KLnl"),E=n("T89o"),k=n("1YJs"),O=n("mGTj"),_=i(n("nmm5")),C=n("KuRP"),R=i(n("YLV/")),T=i(n("yYlr")),F=["titleProfanityError","descriptionProfanityError"];function w(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function B(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?w(Object(n),!0).forEach((function(e){(0,h.default)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function j(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=(0,v.default)(t);if(e){var r=(0,v.default)(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(0,p.default)(this,n)}}function M(){}var D=function(t){(0,d.default)(p,t);var e,n,i=j(p);function p(t){var e;(0,l.default)(this,p),e=i.call(this,t),(0,h.default)((0,f.default)(e),"initialValues",void 0),(0,h.default)((0,f.default)(e),"changedValues",(function(){var t=Object.keys(e.initialValues).filter((function(t){return!(0,E.isEqual)(e.initialValues[t],e.state[t])}));return(0,E.pick)(e.state,t)})),(0,h.default)((0,f.default)(e),"handlePublish",(0,s.default)(o.default.mark((function t(){var n,i,r,a,u,s,l,c,f,d,p,v,h,b,m,g,k,O,R,T,F,w,j;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.changedValues(),i=e.state,r=i.initiativeId,a=i.hasBannerChanged,u=i.image,s=i.oldImageId,l=i.banner,c=i.publishing,f=i.filesToRemove,d=i.files,p=e.props,v=p.onPublished,h=p.locale,b=p.appConfiguration,m=p.authUser,!c){t.next=5;break}return t.abrupt("return");case 5:return e.setState({publishing:!0}),t.prev=6,t.next=9,e.getValuesToSend(n,a,l);case 9:return g=t.sent,t.next=12,(0,y.updateInitiative)(r,B(B({},g),{},{publication_status:"published"}));case 12:if(k=t.sent,e.initialValues=e.getFormValues(k.data),e.setState({hasBannerChanged:!1}),!u||!u.base64||u.id){t.next=18;break}return t.next=18,(0,P.addInitiativeImage)(r,u.base64);case 18:s&&(0,P.deleteInitiativeImage)(r,s).then((function(){e.setState({oldImageId:null})})),f.map((function(t){(0,S.deleteInitiativeFile)(r,t.id).catch((function(t){var n=t.json.errors;e.setState((function(t){return{apiErrors:B(B({},t.apiErrors),n)}})),setTimeout((function(){e.setState((function(t){return{apiErrors:B(B({},t.apiErrors),{},{file:void 0})}}))}),5e3)}))})),d.map((function(t){t.id||(0,S.addInitiativeFile)(r,t.base64,t.name).then((function(e){t.id=e.data.id})).catch((function(t){var n=(0,E.get)(t,"json.errors");e.setState((function(t){return{apiErrors:B(B({},t.apiErrors),n)}})),setTimeout((function(){e.setState((function(t){return{apiErrors:B(B({},t.apiErrors),{},{file:void 0})}}))}),5e3)}))})),v(),t.next=30;break;case 24:t.prev=24,t.t0=t.catch(6),O=(0,E.get)(t.t0,"json.errors"),e.setState((function(t){return{apiErrors:B(B({},t.apiErrors),O),publishError:!0}})),(R=O.base.find((function(t){return"includes_banned_words"===t.error})))&&(T=R.blocked_words.some((function(t){return"title_multiloc"===t.attribute})),F=R.blocked_words.some((function(t){return"body_multiloc"===t.attribute})),T&&((0,C.trackEventByName)(_.default.titleProfanityError.name,{locale:h,profaneMessage:null===(w=n.title_multiloc)||void 0===w?void 0:w[h],proposalId:r,location:"InitiativesEditFormWrapper (citizen side)",userId:(0,I.isNilOrError)(m)?null:m.id,host:(0,I.isNilOrError)(b)?null:b.attributes.host}),e.setState({titleProfanityError:T})),F&&((0,C.trackEventByName)(_.default.descriptionProfanityError.name,{locale:h,profaneMessage:null===(j=n.body_multiloc)||void 0===j?void 0:j[h],proposalId:r,location:"InitiativesEditFormWrapper (citizen side)",userId:(0,I.isNilOrError)(m)?null:m.id,host:(0,I.isNilOrError)(b)?null:b.attributes.host}),e.setState({descriptionProfanityError:F})));case 30:e.setState({publishing:!1});case 31:case"end":return t.stop()}}),t,null,[[6,24]])})))),(0,h.default)((0,f.default)(e),"onChangeTitle",(function(t){e.setState({title_multiloc:t,titleProfanityError:!1})})),(0,h.default)((0,f.default)(e),"onChangeBody",(function(t){e.setState({body_multiloc:t,descriptionProfanityError:!1})})),(0,h.default)((0,f.default)(e),"onChangeTopics",(function(t){e.setState({topic_ids:t})})),(0,h.default)((0,f.default)(e),"onChangePosition",(function(t){e.setState({position:t})})),(0,h.default)((0,f.default)(e),"onChangeBanner",(function(t){e.setState({banner:t,hasBannerChanged:!0})})),(0,h.default)((0,f.default)(e),"onChangeImage",(function(t){t?e.setState({image:t}):e.setState((function(e){var n=e.image&&e.image.id;return n?{image:t,oldImageId:n}:{image:t,oldImageId:e.oldImageId}}))})),(0,h.default)((0,f.default)(e),"onAddFile",(function(t){e.setState((function(e){var n=e.files;return{files:[].concat((0,u.default)(n),[t])}}))})),(0,h.default)((0,f.default)(e),"onRemoveFile",(function(t){e.setState((function(e){var n=e.files;return{files:(0,u.default)(n).filter((function(e){return e.base64!==t.base64}))}})),t.id&&e.setState((function(e){var n=e.filesToRemove;return{filesToRemove:[].concat((0,u.default)(n),[t])}}))}));var n=t.initiative,r=t.initiativeFiles;return e.initialValues=e.getFormValues(n),e.state=B(B({},e.initialValues),{},{oldImageId:null,image:void 0,initiativeId:n.id,publishing:!1,hasBannerChanged:!1,banner:void 0,files:r||[],publishError:!1,apiErrors:null,filesToRemove:[],titleProfanityError:!1,descriptionProfanityError:!1}),e}return(0,c.default)(p,[{key:"componentDidMount",value:function(){var t=this,e=this.props,n=e.initiativeImage,i=e.initiative;if(n&&n.attributes.versions.large){var r=n.attributes.versions.large,a=n.id;(0,k.convertUrlToUploadFile)(r,a,null).then((function(e){t.setState({image:e})}))}if(i&&i.attributes.header_bg.large){var o=i.attributes.header_bg.large;(0,k.convertUrlToUploadFile)(o,null,null).then((function(e){t.setState({banner:e})}))}}},{key:"parsePosition",value:(n=(0,s.default)(o.default.mark((function t(e){var n,i;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.t0=e,t.next=null===t.t0||""===t.t0?3:void 0===t.t0?6:9;break;case 3:return n=null,i=null,t.abrupt("break",14);case 6:return n=void 0,i=void 0,t.abrupt("break",14);case 9:return t.next=11,(0,O.geocode)(e);case 11:return n=t.sent,i=e,t.abrupt("break",14);case 14:return t.abrupt("return",{location_point_geojson:n,location_description:i});case 15:case"end":return t.stop()}}),t)}))),function(t){return n.apply(this,arguments)})},{key:"getValuesToSend",value:(e=(0,s.default)(o.default.mark((function t(e,n,i){var r,a,u,s,l,c;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.title_multiloc,a=e.body_multiloc,u=e.topic_ids,s=e.position,t.next=3,this.parsePosition(s);case 3:return l=t.sent,c=(0,E.omitBy)(B({title_multiloc:r,body_multiloc:a,topic_ids:u},l),(function(t){return void 0===t})),n&&(c.header_bg=i?i.base64:null),t.abrupt("return",c);case 7:case"end":return t.stop()}}),t,this)}))),function(t,n,i){return e.apply(this,arguments)})},{key:"getFormValues",value:function(t){return(0,I.isNilOrError)(t)?this.initialValues:{title_multiloc:(0,E.get)(t,"attributes.title_multiloc",void 0)||void 0,body_multiloc:(0,E.get)(t,"attributes.body_multiloc",void 0)||void 0,topic_ids:(0,E.get)(t,"relationships.topics.data",[]).map((function(t){return t.id})),position:(0,E.get)(t,"attributes.location_description",void 0)||void 0}}},{key:"render",value:function(){var t=this.state,e=t.titleProfanityError,n=t.descriptionProfanityError,i=(0,a.default)(t,F),o=this.props,u=o.locale,s=o.initiativeImage,l=o.topics;return void 0===this.state.image&&s?null:b.default.createElement(g.default,(0,r.default)({onPublish:this.handlePublish,onSave:M,locale:u},i,{onChangeTitle:this.onChangeTitle,onChangeBody:this.onChangeBody,onChangeTopics:this.onChangeTopics,onChangePosition:this.onChangePosition,onChangeBanner:this.onChangeBanner,onChangeImage:this.onChangeImage,onAddFile:this.onAddFile,onRemoveFile:this.onRemoveFile,topics:l,titleProfanityError:e,descriptionProfanityError:n}))}}]),p}(b.default.PureComponent),x=(0,m.adopt)({appConfiguration:b.default.createElement(T.default,null),authUser:b.default.createElement(R.default,null)});e.default=function(t){return b.default.createElement(x,t,(function(e){return b.default.createElement(D,(0,r.default)({},t,e))}))}},bc9h:function(t,e,n){"use strict";n("SuFq");var i=n("TqRt");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,n("FZtP");var r=i(n("lwsE")),a=i(n("W8MJ")),o=i(n("PJYZ")),u=i(n("7W2i")),s=i(n("a1gu")),l=i(n("Nsbk")),c=i(n("lSNA")),f=i(n("q1tI")),d=n("DtyJ"),p=n("ahDk"),v=i(n("aTp4")),h=n("gkAX"),b=n("T89o");function m(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=(0,l.default)(t);if(e){var r=(0,l.default)(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(0,s.default)(this,n)}}var g=function(t){(0,u.default)(n,t);var e=m(n);function n(t){var i;return(0,r.default)(this,n),i=e.call(this,t),(0,c.default)((0,o.default)(i),"inputProps$",void 0),(0,c.default)((0,o.default)(i),"subscriptions",void 0),i.state={initiativeImages:void 0},i}return(0,a.default)(n,[{key:"componentDidMount",value:function(){var t=this,e=this.props.initiativeId;this.inputProps$=new d.BehaviorSubject({initiativeId:e}),this.subscriptions=[this.inputProps$.pipe((0,p.distinctUntilChanged)((function(t,e){return(0,v.default)(t,e)})),(0,p.switchMap)((function(t){var e=t.initiativeId;return(0,b.isString)(e)?(0,h.initiativeImagesStream)(e).observable:(0,d.of)(null)}))).subscribe((function(e){t.setState({initiativeImages:e?e.data:null})}))]}},{key:"componentDidUpdate",value:function(){var t=this.props.initiativeId;this.inputProps$.next({initiativeId:t})}},{key:"componentWillUnmount",value:function(){this.subscriptions.forEach((function(t){return t.unsubscribe()}))}},{key:"render",value:function(){return(0,this.props.children)(this.state.initiativeImages)}}]),n}(f.default.Component);e.default=g},nmm5:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;e.default={titleProfanityError:{name:"Profane proposal title blocked"},descriptionProfanityError:{name:"Profane proposal description blocked"}}}}]);
//# sourceMappingURL=33.6ded42098244a71cae28.chunk.js.map